<?php

/*
 * This file is part of the stg/hall-of-records package.
 *
 * (c) YTK <yutakaje@gmail.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

declare(strict_types=1);

namespace Tests\HallOfRecords\Import;

use Stg\HallOfRecords\Import\ParsedDataFactory;
use Stg\HallOfRecords\Import\YamlParser;

class YamlParserTest extends \Tests\TestCase
{
    public function testWithNoSections(): void
    {
        $parser = new YamlParser();
        $parsedData = $parser->parse([]);

        $factory = new ParsedDataFactory();

        self::assertEquals(
            $factory->createGlobalProperties(),
            $parsedData->globalProperties()
        );
        self::assertEquals([], $parsedData->games());
    }

    public function testWithNoGames(): void
    {
        $global = $this->globalPropertiesInput();

        $parser = new YamlParser();
        $parsedData = $parser->parse([
            $global,
        ]);

        $factory = new ParsedDataFactory();

        self::assertEquals(
            $factory->createGlobalProperties([
                'description' => 'some description',
            ]),
            $parsedData->globalProperties()
        );
        self::assertEquals([], $parsedData->games());
    }

    public function testWithGlobalTemplates(): void
    {
        $global = $this->globalPropertiesInput();
        $global['templates'] = [
            'games' => <<<'TPL'
{% for data in games %}
{{ include('game') }}
{% endfor %}

TPL,
            'game' => <<<'TPL'
{| class="wikitable" style="text-align: center
|-
! colspan="{{ data.headers|length }}" | {{ data.game.name }}
|-
! {{ data.headers|join(' !! ') }}
{% for columns in data.scores %}
|-
| {{ columns|join(' || ') }}
{% endfor %}
|}

TPL,
        ];

        $parser = new YamlParser();
        $parsedData = $parser->parse([
            $global,
        ]);

        $factory = new ParsedDataFactory();

        self::assertEquals(
            $factory->createGlobalProperties([
                'description' => 'some description',
                'templates' => [
                    'games' => <<<'TPL'
{% for data in games %}
{{ include('game') }}
{% endfor %}

TPL,
                    'game' => <<<'TPL'
{| class="wikitable" style="text-align: center
|-
! colspan="{{ data.headers|length }}" | {{ data.game.name }}
|-
! {{ data.headers|join(' !! ') }}
{% for columns in data.scores %}
|-
| {{ columns|join(' || ') }}
{% endfor %}
|}

TPL,
                ],
            ]),
            $parsedData->globalProperties()
        );
    }

    public function testWithGamesAndDefaultLocale(): void
    {
        $global = $this->globalPropertiesInput();
        $games = $this->gamesInput();

        $parser = new YamlParser();
        $parsedData = $parser->parse(array_merge(
            [$global],
            $games
        ));

        $factory = new ParsedDataFactory();

        self::assertEquals(
            $factory->createGlobalProperties([
                'description' => 'some description',
            ]),
            $parsedData->globalProperties()
        );
        self::assertEquals(
            [
                $factory->createGame(
                    'Mushihimesama Futari 1.5',
                    'Cave',
                    [
                        $factory->createScore('ABI', '530,358,660', [
                            'ship' => 'Palm',
                            'mode' => 'Original',
                            'weapon' => 'Normal',
                            'scoredDate' => '2008-01',
                            'source' => 'Arcadia January 2008',
                        ]),
                        $factory->createScore('ISO / Niboshi', '518,902,716', [
                            'ship' => 'Palm',
                            'mode' => 'Original',
                            'weapon' => 'Abnormal',
                            'scoredDate' => '2007',
                            'source' => 'Superplay DVD',
                        ]),
                    ],
                    $factory->createLayout()
                ),
                $factory->createGame(
                    'Ketsui: Kizuna Jigoku Tachi',
                    'Cave',
                    [
                        $factory->createScore('SPS', '507,780,433', [
                            'ship' => 'Type A',
                            'mode' => 'Omote',
                            'scoredDate' => '2014-08',
                            'source' => 'Arcadia August 2014',
                        ]),
                        $factory->createScore('GAN', '569,741,232', [
                            'ship' => 'Type B',
                            'mode' => 'Ura',
                            'scoredDate' => '2016-03',
                            'source' => 'JHA March 2016',
                            'comments' => [
                                '6L remaining',
                                '1st loop 285m',
                            ],
                        ]),
                    ],
                    $factory->createLayout(
                        [
                            $factory->createColumn('Ship', '{{ship}}', [
                                'groupSameValues' => true,
                            ]),
                            $factory->createColumn('Loop', '{{mode}}'),
                            $factory->createColumn('Score', '{{score}}'),
                            $factory->createColumn('Player', '{{player}}', [
                                'groupSameValues' => true,
                            ]),
                            $factory->createColumn(
                                'Date / Source',
                                '{{scored-date}} / {{source}}'
                            ),
                            $factory->createColumn('Comment', '{{comments}}'),
                        ],
                        [
                            'ship' => 'asc',
                            'mode' => 'asc',
                            'score' => 'desc',
                        ]
                    )
                ),
            ],
            $parsedData->games()
        );
    }

    public function testWithGamesAndEnLocale(): void
    {
        $global = $this->globalPropertiesInput();
        $games = $this->gamesInput();
        $locale = 'en';

        $parser = new YamlParser();
        $parsedData = $parser->parse(
            array_merge(
                [$global],
                $games
            ),
            $locale
        );

        $factory = new ParsedDataFactory();

        self::assertEquals(
            $factory->createGlobalProperties([
                'description' => 'some description',
            ]),
            $parsedData->globalProperties()
        );
        self::assertEquals(
            [
                $factory->createGame(
                    'Mushihimesama Futari 1.5',
                    'Cave',
                    [
                        $factory->createScore('ABI', '530,358,660', [
                            'ship' => 'Palm',
                            'mode' => 'Original',
                            'weapon' => 'Normal',
                            'scoredDate' => '2008-01',
                            'source' => 'Arcadia January 2008',
                        ]),
                        $factory->createScore('ISO / Niboshi', '518,902,716', [
                            'ship' => 'Palm',
                            'mode' => 'Original',
                            'weapon' => 'Abnormal',
                            'scoredDate' => '2007',
                            'source' => 'Superplay DVD',
                        ]),
                    ],
                    $factory->createLayout()
                ),
                $factory->createGame(
                    'Ketsui: Kizuna Jigoku Tachi',
                    'Cave',
                    [
                        $factory->createScore('SPS', '507,780,433', [
                            'ship' => 'Tiger Schwert',
                            'mode' => 'Omote',
                            'scoredDate' => '2014-08',
                            'source' => 'Arcadia August 2014',
                        ]),
                        $factory->createScore('GAN', '569,741,232', [
                            'ship' => 'Panzer JÃ¤ger',
                            'mode' => 'Ura',
                            'scoredDate' => '2016-03',
                            'source' => 'JHA March 2016',
                            'comments' => [
                                '6L remaining',
                                '1st loop 285m',
                            ],
                        ]),
                    ],
                    $factory->createLayout(
                        [
                            $factory->createColumn('Ship', '{{ship}}', [
                                'groupSameValues' => true,
                            ]),
                            $factory->createColumn('Loop', '{{mode}}'),
                            $factory->createColumn('Score', '{{score}}'),
                            $factory->createColumn('Player', '{{player}}', [
                                'groupSameValues' => true,
                            ]),
                            $factory->createColumn(
                                'Date / Source',
                                '{{scored-date}} / {{source}}'
                            ),
                            $factory->createColumn('Comment', '{{comments}}'),
                        ],
                        [
                            'ship' => 'asc',
                            'mode' => 'asc',
                            'score' => 'desc',
                        ]
                    )
                ),
            ],
            $parsedData->games()
        );
    }

    public function testWithGamesJpLocale(): void
    {
        $global = $this->globalPropertiesInput();
        $games = $this->gamesInput();
        $locale = 'jp';

        $parser = new YamlParser();
        $parsedData = $parser->parse(
            array_merge(
                [$global],
                $games
            ),
            $locale
        );

        $factory = new ParsedDataFactory();

        self::assertEquals(
            $factory->createGlobalProperties([
                'description' => 'ããèª¬æ',
            ]),
            $parsedData->globalProperties()
        );
        self::assertEquals(
            [
                $factory->createGame(
                    'è«å§«ãã¾ãµããVer 1.5',
                    'ã±ã¤ã',
                    [
                        $factory->createScore('ABI', '530,358,660', [
                            'ship' => 'Palm',
                            'mode' => 'Original',
                            'weapon' => 'Normal',
                            'scoredDate' => '2008-01',
                            'source' => 'Arcadia January 2008',
                        ]),
                        $factory->createScore('ISO / Niboshi', '518,902,716', [
                            'ship' => 'Palm',
                            'mode' => 'Original',
                            'weapon' => 'Abnormal',
                            'scoredDate' => '2007',
                            'source' => 'Superplay DVD',
                        ]),
                    ],
                    $factory->createLayout()
                ),
                $factory->createGame(
                    'ã±ãã¤ ï½çµå°çãã¡ï½',
                    'ã±ã¤ã',
                    [
                        $factory->createScore('SPS', '507,780,433', [
                            'ship' => 'TYPE-A ãã£ã¼ã²ã«ã·ã¥ãã«ã',
                            'mode' => 'è¡¨2é±',
                            'scoredDate' => '2014-08',
                            'source' => 'Arcadia August 2014',
                        ]),
                        $factory->createScore('GAN', '569,741,232', [
                            'ship' => 'TYPE-B ãã³ãã¡ã¼ã¤ã§ã¼ã¬ã¼',
                            'mode' => 'è£2é±',
                            'scoredDate' => '2016-03',
                            'source' => 'JHA March 2016',
                            'comments' => [
                                'æ®6æ©',
                                '1å¨ 2.85å',
                            ],
                        ]),
                    ],
                    $factory->createLayout(
                        [
                            $factory->createColumn('èªæ©', '{{ship}}', [
                                'groupSameValues' => true,
                            ]),
                            $factory->createColumn('2é±ç¨®', '{{mode}}'),
                            $factory->createColumn('ã¹ã³ã¢', '{{score}}'),
                            $factory->createColumn('ãã¬ã¤ã¤ã¼', '{{player}}', [
                                'groupSameValues' => true,
                            ]),
                            $factory->createColumn(
                                'å¹´ææ¥ / æå ±å',
                                '{{scored-date}} / {{source}}'
                            ),
                            $factory->createColumn('åè', '{{comments}}'),
                        ],
                        [
                            'ship' => 'asc',
                            'mode' => 'asc',
                            'score' => 'desc',
                        ]
                    )
                ),
            ],
            $parsedData->games()
        );
    }

    /**
     * @return array<string,mixed>
     */
    private function globalPropertiesInput(): array
    {
        return [
            'name' => 'global',
            'description' => 'some description',
            'description-jp' => 'ããèª¬æ',
            'translations' => [
                [
                    'property' => 'company',
                    'value' => 'Cave',
                    'value-jp' => 'ã±ã¤ã',
                ],
            ],
        ];
    }

    /**
     * @return array<string,mixed>[]
     */
    private function gamesInput(): array
    {
        return [
            [
                'name' => 'Mushihimesama Futari 1.5',
                'name-jp' => 'è«å§«ãã¾ãµããVer 1.5',
                'company' => 'Cave',
                'entries' => [
                    [
                        'player' => 'ABI',
                        'score' => '530,358,660',
                        'ship' => 'Palm',
                        'mode' => 'Original',
                        'weapon' => 'Normal',
                        'scored-date' => '2008-01',
                        'source' => 'Arcadia January 2008',
                    ],
                    [
                        'player' => 'ISO / Niboshi',
                        'score' => '518,902,716',
                        'ship' => 'Palm',
                        'mode' => 'Original',
                        'weapon' => 'Abnormal',
                        'scored-date' => '2007',
                        'source' => 'Superplay DVD',
                    ],
                ],
            ],
            [
                'name' => 'Ketsui: Kizuna Jigoku Tachi',
                'name-jp' => 'ã±ãã¤ ï½çµå°çãã¡ï½',
                'company' => 'Cave',
                'entries' => [
                    [
                        'player' => 'SPS',
                        'score' => '507,780,433',
                        'ship' => 'Type A',
                        'mode' => 'Omote',
                        'scored-date' => '2014-08',
                        'source' => 'Arcadia August 2014',
                        'comments' => [],
                    ],
                    [
                        'player' => 'GAN',
                        'score' => '569,741,232',
                        'ship' => 'Type B',
                        'mode' => 'Ura',
                        'scored-date' => '2016-03',
                        'source' => 'JHA March 2016',
                        'comments' => [
                            '6L remaining',
                            '1st loop 285m',
                        ],
                        'comments-jp' => [
                            'æ®6æ©',
                            '1å¨ 2.85å',
                        ],
                    ],
                ],
                'translations' => [
                    [
                        'property' => 'ship',
                        'value' => 'Type A',
                        'value-en' => 'Tiger Schwert',
                        'value-jp' => 'TYPE-A ãã£ã¼ã²ã«ã·ã¥ãã«ã',
                    ],
                    [
                        'property' => 'ship',
                        'value' => 'Type B',
                        'value-en' => 'Panzer JÃ¤ger',
                        'value-jp' => 'TYPE-B ãã³ãã¡ã¼ã¤ã§ã¼ã¬ã¼',
                    ],
                    [
                        'property' => 'mode',
                        'value' => 'Omote',
                        'value-jp' => 'è¡¨2é±',
                    ],
                    [
                        'property' => 'mode',
                        'value' => 'Ura',
                        'value-jp' => 'è£2é±',
                    ],
                ],
                'layout' => [
                    'columns' => [
                        [
                            'label' => 'Ship',
                            'label-jp' => 'èªæ©',
                            'value' => '{{ship}}',
                            'groupSameValues' => true,
                        ],
                        [
                            'label' => 'Loop',
                            'label-jp' => '2é±ç¨®',
                            'value' => '{{mode}}',
                        ],
                        [
                            'label' => 'Score',
                            'label-jp' => 'ã¹ã³ã¢',
                            'value' => '{{score}}',
                        ],
                        [
                            'label' => 'Player',
                            'label-jp' => 'ãã¬ã¤ã¤ã¼',
                            'value' => '{{player}}',
                            'groupSameValues' => true,
                        ],
                        [
                            'label' => 'Date / Source',
                            'label-jp' => 'å¹´ææ¥ / æå ±å',
                            'value' => '{{scored-date}} / {{source}}',
                        ],
                        [
                            'label' => 'Comment',
                            'label-jp' => 'åè',
                            'value' => '{{comments}}',
                        ],
                    ],
                    'sort' => [
                        'ship' => 'asc',
                        'mode' => 'asc',
                        'score' => 'desc',
                    ],
                ],
            ],
        ];
    }
}
